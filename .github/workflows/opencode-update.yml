name: Update OpenCode
on:
  schedule:
    # Run twice daily at 3 AM and 3 PM UTC (1 hour after main update workflow)
    - cron: '0 3,15 * * *'
  workflow_dispatch:
jobs:
  # First job: Update the main package on x86_64-linux
  update-package:
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.update.outputs.updated }}
      current_version: ${{ steps.update.outputs.current_version }}
      new_version: ${{ steps.update.outputs.new_version }}
    permissions:
      contents: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
      - name: Setup Nix
        uses: cachix/install-nix-action@v31
      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Update OpenCode package
        id: update
        run: |
          set -euo pipefail

          # Get current version
          current_version=$(nix eval .#packages.x86_64-linux.opencode.version --raw)
          echo "current_version=$current_version" >> $GITHUB_OUTPUT

          # Run nix-update for the main package (including tui and node_modules for x86_64-linux)
          nix run --inputs-from . nixpkgs#nix-update -- --flake opencode

          # Get new version
          new_version=$(nix eval .#packages.x86_64-linux.opencode.version --raw)
          echo "new_version=$new_version" >> $GITHUB_OUTPUT

          if [ "$current_version" = "$new_version" ]; then
            echo "No update available"
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "Updated from $current_version to $new_version"
            echo "updated=true" >> $GITHUB_OUTPUT
          fi
      - name: Upload updated package
        if: steps.update.outputs.updated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: opencode-x86_64-linux
          path: |
            packages/opencode/package.nix
          retention-days: 1
  update-hashes:
    needs: update-package
    if: needs.update-package.outputs.updated == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # x86_64-linux runner
          - os: ubuntu-latest
            platform: "x86_64-linux"
          # macOS runner (covers both Darwin platforms)
          - os: macos-latest
            platform: "x86_64-darwin"
          - os: macos-latest
            platform: "aarch64-darwin"
          # aarch64-linux (native ARM runner)
          - os: ubuntu-22.04-arm
            platform: "aarch64-linux"
    permissions:
      contents: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
      - name: Download x86_64-linux update
        uses: actions/download-artifact@v4
        with:
          name: opencode-x86_64-linux
          path: packages/opencode/
      - name: Setup Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            system-features = nixos-test benchmark big-parallel kvm
      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Update node_modules hash for ${{ matrix.platform }}
        run: .github/actions/opencode-update-node-modules-hash.sh "${{ matrix.platform }}"
      - name: Upload hash update
        uses: actions/upload-artifact@v4
        with:
          name: hash-${{ matrix.platform }}
          path: hash-${{ matrix.platform }}.txt
          retention-days: 1
  # Final job: Merge all updates and create PR
  create-pr:
    needs: [update-package, update-hashes]
    if: needs.update-package.outputs.updated == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: hash-*
          path: /tmp/hashes/
      - name: Download package update
        uses: actions/download-artifact@v4
        with:
          name: opencode-x86_64-linux
          path: packages/opencode/
      - name: Merge hash updates
        run: .github/actions/opencode-merge-hashes.py
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: "opencode: ${{ needs.update-package.outputs.current_version }} -> ${{ needs.update-package.outputs.new_version }}"
          title: "opencode: ${{ needs.update-package.outputs.current_version }} -> ${{ needs.update-package.outputs.new_version }}"
          body: |
            Automated update of OpenCode from ${{ needs.update-package.outputs.current_version }} to ${{ needs.update-package.outputs.new_version }}
          branch: update-opencode-${{ needs.update-package.outputs.new_version }}
          labels: |
            dependencies
            automated
      - name: Enable auto-merge
        if: steps.cpr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh pr merge ${{ steps.cpr.outputs.pull-request-number }} --auto --merge
